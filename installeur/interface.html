<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>NPCForge â€” Installation</title>

	<meta http-equiv="Content-Security-Policy"
		  content="default-src 'self' https://cdn.jsdelivr.net; 
				   script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
				   style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline';
				   img-src 'self' data:;">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

	<style>
		body { background:#121212; color:#eaeaea; }
		.container-narrow { max-width: 920px; }
		.card { background:#1b1b1b; border-color:#2a2a2a; }
		.badge-soft { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); }
		.step-title { display:flex; align-items:center; gap:.5rem; }
		.step-status { font-size:.9rem; opacity:.9; }
		small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; opacity:.85; }
	</style>
</head>
<body>
	<div class="container container-narrow py-4">
		<h1 class="mb-1">ðŸš€ NPCForge â€” Assistant dâ€™installation</h1>
		<p class="text-secondary">VÃ©rifie Docker, installe lâ€™API et le Jeu.</p>

		<div class="d-flex gap-2 my-3">
			<button id="start" class="btn btn-primary">Lancer lâ€™installation</button>
			<button id="open-launcher" class="btn btn-outline-light d-none">Ouvrir le Launcher</button>
		</div>

		<!-- Ã‰tape 1: Docker -->
		<div class="card mb-3">
			<div class="card-header d-flex justify-content-between align-items-center">
				<div class="step-title">
					<span class="badge rounded-pill badge-soft">1</span>
					<strong>Docker</strong>
				</div>
				<div id="s1-status" class="step-status text-warning">En attenteâ€¦</div>
			</div>
			<div class="card-body">
				<small class="mono text-secondary d-block mb-2">docker --version</small>
				<div class="progress"><div id="s1-bar" class="progress-bar progress-bar-striped" style="width:0%"></div></div>
				<div id="s1-log" class="mt-2 small text-secondary"></div>
			</div>
		</div>

		<!-- Ã‰tape 2: API -->
		<div class="card mb-3">
			<div class="card-header d-flex justify-content-between align-items-center">
				<div class="step-title">
					<span class="badge rounded-pill badge-soft">2</span>
					<strong>API (release la plus rÃ©cente)</strong>
				</div>
				<div id="s2-status" class="step-status text-warning">En attenteâ€¦</div>
			</div>
			<div class="card-body">
				<small class="mono text-secondary d-block mb-2">TÃ©lÃ©chargement, .env, docker compose up -d</small>
				<div class="progress"><div id="s2-bar" class="progress-bar progress-bar-striped" style="width:0%"></div></div>
				<div id="s2-log" class="mt-2 small text-secondary"></div>
			</div>
		</div>

		<!-- Ã‰tape 3: Jeu -->
		<div class="card mb-3">
			<div class="card-header d-flex justify-content-between align-items-center">
				<div class="step-title">
					<span class="badge rounded-pill badge-soft">3</span>
					<strong>Jeu (release v1.1)</strong>
				</div>
				<div id="s3-status" class="step-status text-warning">En attenteâ€¦</div>
			</div>
			<div class="card-body">
				<small class="mono text-secondary d-block mb-2">TÃ©lÃ©chargement et prÃ©paration du binaire</small>
				<div class="progress"><div id="s3-bar" class="progress-bar progress-bar-striped" style="width:0%"></div></div>
				<div id="s3-log" class="mt-2 small text-secondary"></div>
			</div>
		</div>
	</div>

	<script>
		// helpers UI
		const setStatus=(el,t,c)=>{el.classList.remove("text-warning","text-success","text-danger"); if(c)el.classList.add(c); el.textContent=t}
		const setBar=(el,p,a=false,s=true)=>{el.style.width=p+"%"; el.setAttribute("aria-valuenow",p); el.classList.toggle("progress-bar-striped",s); el.classList.toggle("progress-bar-animated",a)}
		const log=(el,msg)=>{el.innerHTML=(el.innerHTML?el.innerHTML+"<br>":"")+msg}
		const sleep=(ms)=>new Promise(r=>setTimeout(r,ms))

		const startBtn = document.getElementById("start")
		const launcherBtn = document.getElementById("open-launcher")

		const s1={status:document.getElementById("s1-status"), bar:document.getElementById("s1-bar"), log:document.getElementById("s1-log")}
		const s2={status:document.getElementById("s2-status"), bar:document.getElementById("s2-bar"), log:document.getElementById("s2-log")}
		const s3={status:document.getElementById("s3-status"), bar:document.getElementById("s3-bar"), log:document.getElementById("s3-log")}

		// Ã©couter les progress du main (downloads)
		window.launcher.onProgress?.((p)=>{
			if(p.step==="api-download"){
				setStatus(s2.status,"TÃ©lÃ©chargement de lâ€™APIâ€¦","text-warning")
				const pct = p.total? Math.min(99, Math.floor((p.received/p.total)*90)+10) : 50
				setBar(s2.bar,pct,true,true)
			}
			if(p.step==="game-download"){
				setStatus(s3.status,"TÃ©lÃ©chargement du Jeuâ€¦","text-warning")
				const pct = p.total? Math.min(99, Math.floor((p.received/p.total)*90)+10) : 50
				setBar(s3.bar,pct,true,true)
			}
		})

		async function ensureDocker() {
			setStatus(s1.status,"VÃ©rification Dockerâ€¦","text-warning"); setBar(s1.bar,15,true,true)
			try{
				const c = await window.launcher.checkDocker()
				if(c?.installed){
					setBar(s1.bar,100,false,false); setStatus(s1.status,`Docker OK (${c.version})`,"text-success")
					return true
				}
				log(s1.log, `<span class="text-warning">â€¢</span> Absent: ${c?.error||"non dÃ©tectÃ©"}`)
			}catch(e){ log(s1.log, `<span class="text-danger">âœ–</span> ${e?.message||e}`)}

			// installer
			setStatus(s1.status,"Installation Dockerâ€¦","text-warning"); setBar(s1.bar,40,true,true)
			await window.launcher.installDocker().catch(e=>log(s1.log, `<span class="text-danger">âœ–</span> ${e?.message||e}`))
			setStatus(s1.status,"Attente que Docker soit prÃªtâ€¦","text-warning"); setBar(s1.bar,60,true,true)

			for(let i=0;i<120;i++){ // ~10 min
				await sleep(5000)
				try{
					const c=await window.launcher.checkDocker()
					if(c?.installed){ setBar(s1.bar,100,false,false); setStatus(s1.status,`Docker prÃªt (${c.version})`,"text-success"); return true }
				}catch{}
			}
			setStatus(s1.status,"Timeout Docker","text-danger"); setBar(s1.bar,95,false,true); return false
		}

		async function installAPI() {
			setStatus(s2.status,"PrÃ©parationâ€¦","text-warning"); setBar(s2.bar,5,true,true)
			try{
				const info = await window.launcher.apiDownloadLatest()
				log(s2.log, `<span class="text-success">âœ”</span> Release: ${info.name||info.tag}`)
				log(s2.log, `<span class="text-secondary">â†’</span> Dossier: ${info.destDir}`)
				if(info.envPath){ log(s2.log, `<span class="text-secondary">â†’</span> .env: ${info.envPath}`) }
				setStatus(s2.status,"DÃ©marrage docker composeâ€¦","text-warning"); setBar(s2.bar,92,true,true)
				const up = await window.launcher.apiComposeUp()
				if(!up.ok){
					setStatus(s2.status,"Ã‰chec docker compose","text-danger"); setBar(s2.bar,95,false,true)
					log(s2.log, `<span class="text-danger">âœ–</span> ${up.error||up.stderr||"compose failed"}`)
					return false
				}
				setBar(s2.bar,100,false,false); setStatus(s2.status,"API prÃªte","text-success")
				return true
			}catch(e){
				setStatus(s2.status,"Erreur API","text-danger"); setBar(s2.bar,95,false,true)
				log(s2.log, `<span class="text-danger">âœ–</span> ${e?.message||e}`); return false
			}
		}

		async function installGame() {
			setStatus(s3.status,"TÃ©lÃ©chargementâ€¦","text-warning"); setBar(s3.bar,10,true,true)
			try{
				const g = await window.launcher.gameDownload()
				log(s3.log, `<span class="text-success">âœ”</span> Release: ${g.name||g.tag}`)
				log(s3.log, `<span class="text-secondary">â†’</span> Fichier: ${g.destFile}`)
				setBar(s3.bar,100,false,false); setStatus(s3.status,"Jeu prÃªt","text-success")
				return true
			}catch(e){
				setStatus(s3.status,"Erreur tÃ©lÃ©chargement","text-danger"); setBar(s3.bar,95,false,true)
				log(s3.log, `<span class="text-danger">âœ–</span> ${e?.message||e}`); return false
			}
		}

		async function runAll() {
			startBtn.disabled = true
			const ok1 = await ensureDocker()
			if (!ok1) { startBtn.disabled = false; return }
			const ok2 = await installAPI()
			if (!ok2) { startBtn.disabled = false; return }
			const ok3 = await installGame()
			if (!ok3) { startBtn.disabled = false; return }
			startBtn.disabled = false
			launcherBtn.classList.remove("d-none")
		}

		startBtn.addEventListener("click", runAll)
		launcherBtn.addEventListener("click", ()=> window.launcher.navigate("interface"))
	</script>
</body>
</html>
